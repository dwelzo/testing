

##  **1️⃣ The Big Picture**

When writing **unit tests**, you want to test **only your code**, not your dependencies.

But what if your function calls:

* A **database** 🗄️
* A **network API** 🌐
* A **file system** 📁
* Or another **service** 🔗

You don’t want those to actually run — they make tests:

* Slow 🐢
* Unreliable 😵‍💫
* Dependent on network or data 💥

So we replace them with **test doubles** like:
👉 **stubs** and **mocks**

---

## 🧠 **2️⃣ What Are Stubs and Mocks (Simple Definition)**

| Type        | Purpose                            | Behavior                           |
| ----------- | ---------------------------------- | ---------------------------------- |
| 🧱 **Stub** | *Provides fake data*               | You tell it what to return         |
| 🎭 **Mock** | *Checks how a dependency was used* | You verify it was called correctly |

---

## ⚙️ **3️⃣ Example Scenario**

Let’s say you have this function:

```ts
import { getUserFromDB, sendEmail } from "./services";

export function registerUser(email: string) {
  const user = getUserFromDB(email);
  if (user) throw new Error("User already exists");
  sendEmail(email, "Welcome!");
  return "Registration successful";
}
```

Here:

* `getUserFromDB` → talks to a database
* `sendEmail` → sends a real email

You don’t want those running in your unit test ❌
So we’ll use **stubs and mocks**.

---

## 🧱 **4️⃣ Using a Stub**

A **stub** replaces a real function with a fake one that just returns what we tell it to.

```ts
import { registerUser } from "../app/registerUser";
import * as services from "../app/services";

test("registers a new user when user doesn't exist", () => {
  // Stub DB call → simulate user not found
  jest.spyOn(services, "getUserFromDB").mockReturnValue(null);

  // Stub email → no actual email sent
  jest.spyOn(services, "sendEmail").mockImplementation(() => {});

  const result = registerUser("test@example.com");

  expect(result).toBe("Registration successful");
});
```

✅ **Stub advantages:**

* No real DB/email used
* Test runs fast and isolated
* You control the fake data
* Focus stays on your logic

---

## 🎭 **5️⃣ Using a Mock**

A **mock** not only fakes the function — it also **records how it was called** so you can verify behavior.

```ts
test("should send welcome email after registration", () => {
  jest.spyOn(services, "getUserFromDB").mockReturnValue(null);
  const emailMock = jest.spyOn(services, "sendEmail").mockImplementation(() => {});

  registerUser("hello@dwelzo.com");

  // Assert it was called with right arguments
  expect(emailMock).toHaveBeenCalledWith("hello@dwelzo.com", "Welcome!");
});
```

✅ **Mock advantages:**

* Verify **behavior** (was it called?)
* Verify **arguments**
* Ensure **order of calls** if needed

---

## 🧩 **6️⃣ Difference Between Stub and Mock (Quick Summary)**

| Feature     | Stub                  | Mock                     |
| ----------- | --------------------- | ------------------------ |
| Purpose     | Provide data          | Verify interactions      |
| Focus       | Output                | Behavior                 |
| Example use | Fake DB or API return | Check if email sent      |
| Assertion   | On result             | On function call         |
| Jest method | `mockReturnValue()`   | `toHaveBeenCalledWith()` |

---

## 🧭 **7️⃣ Why “Use Stubs and Mocks Wisely”?**

Because **overusing** them causes trouble ⚠️

### ❌ **Over-Mocking Problems**

| Issue                  | Description                                            |
| ---------------------- | ------------------------------------------------------ |
| 💥 Fragile tests       | Change in code breaks test even if logic still correct |
| 😵‍💫 False confidence | You test mocks, not real behavior                      |
| 🐢 Slow tests          | Too many dependencies mocked                           |
| 🧩 Hard maintenance    | Mocks everywhere, unclear real flow                    |

---

### ✅ **Wise Usage Guidelines**

| Rule                                         | Description                                                |
| -------------------------------------------- | ---------------------------------------------------------- |
| 🎯 Mock only external dependencies           | API calls, DB, file I/O                                    |
| 🚫 Don’t mock what you own                   | Pure functions, helpers — test them directly               |
| 🔁 Reset mocks each test                     | `afterEach(() => jest.clearAllMocks());`                   |
| 🧱 Use stubs for *data setup*                | When you just need fake data                               |
| 🕵️‍♂️ Use mocks for *behavior verification* | When you need to ensure a call was made                    |
| 🧹 Keep tests readable                       | Prefer descriptive mock names                              |
| 🧪 Combine with edge cases                   | Test both success and failure paths                        |
| ⚙️ Mock async correctly                      | `mockResolvedValue()` / `mockRejectedValue()` for promises |

---

## ⚙️ **8️⃣ Example of Bad vs. Good**

### ❌ Bad (Over-mocking)

```ts
jest.spyOn(Math, "max").mockReturnValue(10); // no need to mock built-ins
```

### ✅ Good

```ts
jest.spyOn(api, "fetchData").mockResolvedValue({ id: 1 });
```

Only mock what’s **external** and **unreliable**.

---

## 🧩 **9️⃣ Real-Life Analogy**

* **Stub:** Like a **fake waiter** who always tells you “We have pizza today” — predictable answer.
* **Mock:** Like a **restaurant manager** who checks if the waiter asked customers for their order — verifies behavior.

You use them so you don’t depend on the *real kitchen* while testing your service flow 🍕

---

## 🧠 **🔟 Summary Table**

| Concept    | Meaning                             | When to Use                                      |
| ---------- | ----------------------------------- | ------------------------------------------------ |
| Stub       | Fake returns fixed data             | When testing logic that depends on external data |
| Mock       | Records and verifies function calls | When testing if something *was called* correctly |
| Use Wisely | Only for dependencies, not own code | Keep tests simple, isolated, reliable            |

---

